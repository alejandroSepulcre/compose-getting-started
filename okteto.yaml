name: compose-getting-started

build: 
  vote:
    context: vote

deploy:
  image: okteto/tfenv-ci:1.4
  commands:
    - helm repo add bitnami https://charts.bitnami.com/bitnami; terraform init -backend-config="config_path=${KUBECONFIG}" -backend-config="namespace=$OKTETO_NAMESPACE" -reconfigure; export TF_VAR_OKTETO_BUILD_VOTE_IMAGE=${OKTETO_BUILD_VOTE_IMAGE} TF_VAR_KUBECONFIG=$KUBECONFIG TF_VAR_OKTETO_NAMESPACE=$OKTETO_NAMESPACE; terraform apply --auto-approve; terraform test

destroy:
  image: okteto/tfenv-ci:1.4
  commands:
    - terraform init -backend-config="config_path=${KUBECONFIG}" -backend-config="namespace=$OKTETO_NAMESPACE" -reconfigure; export TF_VAR_KUBECONFIG=$KUBECONFIG; terraform destroy --auto-approve